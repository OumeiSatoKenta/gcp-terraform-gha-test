name: 'Terraform Plan'

on:
  pull_request:
    branches:
      - main
      - develop

env:
  TF_VERSION: '1.13.5'
  TF_WORKING_DIR: './'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  determine-environment:
    name: 'Determine Environment'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine.outputs.environment }}
    steps:
      - name: Determine environment
        id: determine
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          echo "Ref: ${{ github.ref }}"

          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
          elif [[ "${{ github.base_ref }}" == "develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_PROJECT_NUMBER }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive
      working-directory: ${{ env.TF_WORKING_DIR }}
      continue-on-error: true

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
        service_account: 'github-actions-terraform@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

    - name: Terraform Init
      id: init
      run: |
        terraform init \
          -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-terraform-state" \
          -backend-config="prefix=terraform/${{ needs.determine-environment.outputs.environment }}/state"
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -no-color -input=false \
          -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
          -var="environment=${{ needs.determine-environment.outputs.environment }}" \
          -out=tfplan
      working-directory: ${{ env.TF_WORKING_DIR }}
      continue-on-error: true

    - name: Generate Plan Summary
      id: summary
      if: always()
      run: |
        echo "## Terraform Plan Summary" >> plan_summary.md
        echo "| Check | Result |" >> plan_summary.md
        echo "|-------|--------|" >> plan_summary.md
        echo "| Format | ${{ steps.fmt.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> plan_summary.md
        echo "| Init | ${{ steps.init.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> plan_summary.md
        echo "| Validate | ${{ steps.validate.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> plan_summary.md
        echo "| Plan | ${{ steps.plan.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> plan_summary.md
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Comment PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      env:
        PLAN: "${{ steps.plan.outputs.stdout }}"
        PLAN_ERROR: "${{ steps.plan.outputs.stderr }}"
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const planSummary = fs.readFileSync('${{ env.TF_WORKING_DIR }}/plan_summary.md', 'utf8');
          
          // Remove ANSI color codes
          const stripAnsi = (str) => str.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
          
          const output = `### üèó Terraform Plan Results
          
          **Environment:** \`${{ needs.determine-environment.outputs.environment }}\`
          **Workspace:** \`${{ env.TF_WORKING_DIR }}\`
          **PR:** #${{ github.event.pull_request.number }}
          
          ${planSummary}
          
          <details><summary>üìã Plan Output</summary>
          
          \`\`\`terraform
          ${stripAnsi(process.env.PLAN || 'No plan output')}
          \`\`\`
          
          </details>
          
          ${ process.env.PLAN_ERROR ? `
          <details><summary>‚ùå Error Output</summary>
          
          \`\`\`
          ${stripAnsi(process.env.PLAN_ERROR)}
          \`\`\`
          
          </details>
          ` : ''}
          
          ---
          <sub>
          Workflow: \`${{ github.workflow }}\`
          Job: \`${{ github.job }}\`
          Run: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          Triggered by: @${{ github.actor }}
          </sub>`;
          
          // Find previous comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => {
            return comment.user.type === 'Bot' && comment.body.includes('üèó Terraform Plan Results');
          });
          
          // Update or create comment
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });
          }

    - name: Terraform Plan Status
      if: steps.plan.outcome == 'failure'
      run: exit 1