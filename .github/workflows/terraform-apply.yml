name: 'Terraform Apply'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      auto_approve:
        description: 'Auto approve the apply (use with caution)'
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: '1.13.5'
  TF_WORKING_DIR: './'

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ inputs.environment }}
    
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_PROJECT_NUMBER }}

    outputs:
      apply_status: ${{ steps.apply.outcome }}
      plan_summary: ${{ steps.show_plan.outputs.summary }}

    steps:
    - name: Validate Environment
      run: |
        if [[ "${{ inputs.environment }}" == "production" ]] && [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
          echo "‚ùå Production deployments are only allowed from main branch"
          exit 1
        fi
        echo "‚úÖ Environment validation passed"

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Terraform Format Check
      id: fmt
      run: |
        echo "üé® Checking Terraform format..."
        terraform fmt -check -recursive
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
        service_account: 'github-actions-terraform@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

    - name: Terraform Init
      id: init
      run: |
        echo "üöÄ Initializing Terraform..."
        terraform init \
          -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-terraform-state" \
          -backend-config="prefix=terraform/${{ inputs.environment }}/state"
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Validate
      id: validate
      run: |
        echo "‚úÖ Validating Terraform configuration..."
        terraform validate
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Plan
      id: plan
      run: |
        echo "üìã Planning Terraform changes..."
        terraform plan \
          -input=false \
          -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
          -var="environment=${{ inputs.environment }}" \
          -out=tfplan \
          -detailed-exitcode || echo "exitcode=$?" >> $GITHUB_OUTPUT
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Show Plan Summary
      id: show_plan
      if: steps.plan.outputs.exitcode == '2'
      run: |
        echo "üìä Generating plan summary..."
        terraform show -no-color tfplan > tfplan.txt
        
        # Extract summary
        echo "summary<<EOF" >> $GITHUB_OUTPUT
        grep -E "Plan:|No changes." tfplan.txt | head -1 >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Show plan in logs
        cat tfplan.txt
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Manual Approval Check
      if: steps.plan.outputs.exitcode == '2' && inputs.auto_approve == false
      run: |
        echo "‚ö†Ô∏è  Manual approval required!"
        echo "Please review the plan output above before proceeding."
        echo "Re-run with 'auto_approve' checked to proceed with the apply."
        exit 1

    - name: Terraform Apply
      id: apply
      if: steps.plan.outputs.exitcode == '2' && inputs.auto_approve == true
      run: |
        echo "üöÄ Applying Terraform changes..."
        terraform apply -auto-approve tfplan
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Output
      id: output
      if: steps.apply.outcome == 'success'
      run: |
        echo "üì§ Retrieving Terraform outputs..."
        terraform output -json > outputs.json
        echo "outputs<<EOF" >> $GITHUB_OUTPUT
        cat outputs.json >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Create Issue for Apply Result
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const title = `Terraform Apply - ${{ inputs.environment }} - ${{ steps.apply.outcome || 'Planned' }}`;
          const applyStatus = '${{ steps.apply.outcome }}';
          const planSummary = `${{ steps.show_plan.outputs.summary }}`;
          
          let statusEmoji = 'üìã';
          if (applyStatus === 'success') statusEmoji = '‚úÖ';
          else if (applyStatus === 'failure') statusEmoji = '‚ùå';
          else if (applyStatus === 'skipped') statusEmoji = '‚è≠Ô∏è';
          
          const body = `## ${statusEmoji} Terraform Apply Report
          
          **Environment:** \`${{ inputs.environment }}\`
          **Branch:** \`${{ github.ref_name }}\`
          **Triggered by:** @${{ github.actor }}
          **Auto Approve:** \`${{ inputs.auto_approve }}\`
          
          ### Status Summary
          | Stage | Status |
          |-------|--------|
          | Format Check | ${{ steps.fmt.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | Init | ${{ steps.init.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | Validate | ${{ steps.validate.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | Plan | ${{ steps.plan.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | Apply | ${applyStatus === 'success' ? '‚úÖ Applied' : applyStatus === 'failure' ? '‚ùå Failed' : '‚è≠Ô∏è Skipped'} |
          
          ### Plan Summary
          \`\`\`
          ${planSummary || 'No changes detected'}
          \`\`\`
          
          ${{ steps.output.outputs.outputs ? `### Outputs
          \`\`\`json
          ${{ steps.output.outputs.outputs }}
          \`\`\`
          ` : ''}}
          
          ### Workflow Details
          - **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Commit:** [\`${{ github.sha.substring(0, 8) }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          
          ---
          <sub>Generated by GitHub Actions</sub>
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['terraform', inputs.environment, applyStatus]
          });

  slack-notification:
    name: 'Slack Notification'
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: always() && vars.SLACK_NOTIFICATIONS_ENABLED == 'true'

    steps:
    - name: Send Slack Notification
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "Terraform Apply ${{ needs.terraform-apply.outputs.apply_status == 'success' && '‚úÖ' || needs.terraform-apply.outputs.apply_status == 'failure' && '‚ùå' || 'üìã' }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ inputs.environment }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n${{ needs.terraform-apply.outputs.apply_status || 'Planned Only' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Triggered by:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Plan Summary:*\n```${{ needs.terraform-apply.outputs.plan_summary || 'No changes' }}```"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK